name: ðŸš€ Continuous Integration

on:
  push:
    branches: ["main","master"]
  pull_request:
    branches: ["main","master"]

jobs:
  security-checks:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: ðŸ’¾ Cache Security Tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-security-tools-ci-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-security-tools-ci-

      - name: Install project dependencies
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ requirements.txt)
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi

      - name: Install security tools (fix pydantic/typer compatibility)
        run: |
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pydantic Ð¸ typer Ð´Ð¾ Ð²ÐµÑ€ÑÐ¸Ð¹ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ñ‹Ñ… Ñ safety/semgrep
          python -m pip install "pydantic>=2.6.0" "typer>=0.16.0"
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð¼ bandit Ð¸ safety Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ñ‘Ð½Ð½Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹
          python -m pip install "bandit==1.8.6" "safety==3.6.2"
          # ÐÐµ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ semgrep Ð² ÑÑ‚Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ action Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²

      - name: Run Bandit
        id: bandit
        run: |
          set -e
          bandit -r backend -f json -o bandit-report.json || true
          jq -r '.results | length' bandit-report.json > bandit_count.txt
          echo "bandit_count=$(cat bandit_count.txt)" >> $GITHUB_OUTPUT

      - name: Run Safety
        id: safety
        run: |
          set -e
          # safety Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ --output json (Ð° Ð½Ðµ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð°). ÐŸÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ Ð² Ñ„Ð°Ð¹Ð».
          safety check --output json > safety-report.json || true
          python - <<PY
import json,sys
try:
    j=json.load(open('safety-report.json'))
    vulns = j.get('vulnerabilities', [])
    print('vulnerability_count:', len(vulns))
except Exception:
    # safety Ð²ÐµÑ€ÑÐ¸Ð¹/Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² Ð¼Ð¾Ð¶ÐµÑ‚ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ð¼
    print('vulnerability_count: 0')
PY
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ, ÐµÑÐ»Ð¸ need
          echo "safety_done=true" >> $GITHUB_OUTPUT

      - name: Run Semgrep (official action to avoid pydantic conflicts)
        id: semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          output_path: semgrep-report.json
          # Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸/Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· input config ÐµÑÐ»Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ:
          # config: p/ci
      - name: Aggregate results and fail on threshold
        run: |
          set -e
          BANDIT_COUNT=$(jq '.results | length' bandit-report.json 2>/dev/null || echo 0)
          SAFETY_COUNT=0
          if [ -f safety-report.json ]; then
            # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð² safety-report.json
            SAFETY_COUNT=$(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo 0)
          fi
          SEMGREP_COUNT=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo 0)

          echo "Bandit issues: $BANDIT_COUNT"
          echo "Safety vulnerabilities: $SAFETY_COUNT"
          echo "Semgrep findings: $SEMGREP_COUNT"

          TOTAL_ISSUES=$((BANDIT_COUNT + SAFETY_COUNT + SEMGREP_COUNT))
          echo "Total issues: $TOTAL_ISSUES"

          # ÐŸÐ¾Ñ€Ð¾Ð³ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´ Ð¿Ñ€Ð¾ÐµÐºÑ‚. Ð—Ð´ÐµÑÑŒ â€” Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ðµ 0 Ð²Ð°Ð¶Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼.
          THRESHOLD=0
          if [ "$TOTAL_ISSUES" -le "$THRESHOLD" ]; then
            echo "âœ… Security checks passed (under threshold)"
            echo "passed=true" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ Security checks failed (too many issues: $TOTAL_ISSUES)"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
