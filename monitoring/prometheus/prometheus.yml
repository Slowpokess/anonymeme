# üìä Prometheus Configuration –¥–ª—è Anonymeme Platform
# Comprehensive monitoring configuration for –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã

global:
  # Scrape –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è high-frequency –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  scrape_interval: 15s
  
  # Evaluation –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è rules - –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
  evaluation_interval: 15s
  
  # –û–±—â–∏–µ labels –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç—Ä–∏–∫
  external_labels:
    cluster: 'anonymeme-platform'
    environment: '${ENVIRONMENT:-development}'
    region: '${AWS_REGION:-us-west-2}'

# Rule files configuration - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª
rule_files:
  - "rules/*.yml"
  - "alerts/*.yml"

# Alertmanager configuration –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
      scheme: http
      timeout: 10s
      api_version: v2

# Scrape configurations - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ —Å–æ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
scrape_configs:

  # ===== PROMETHEUS SELF-MONITORING =====
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 5s
    metrics_path: /metrics

  # ===== BACKEND API MONITORING =====
  - job_name: 'anonymeme-backend'
    static_configs:
      - targets: 
        - 'backend:8000'
        - 'backend-blue:8000'   # Blue environment
        - 'backend-green:8001'  # Green environment
    metrics_path: '/metrics'
    scrape_interval: 10s
    scrape_timeout: 8s
    honor_labels: true
    params:
      format: ['prometheus']
    # Basic auth –¥–ª—è protected metrics endpoints
    basic_auth:
      username: '${METRICS_USERNAME:-metrics}'
      password: '${METRICS_PASSWORD:-metrics_secret}'
    # Custom labels –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
      - source_labels: [__address__]
        regex: '.*-blue:.*'
        target_label: environment_color
        replacement: 'blue'
      - source_labels: [__address__]
        regex: '.*-green:.*'
        target_label: environment_color
        replacement: 'green'
      - target_label: service
        replacement: 'backend-api'

  # ===== FRONTEND MONITORING =====
  - job_name: 'anonymeme-frontend'
    static_configs:
      - targets:
        - 'frontend:3000'
        - 'frontend-blue:3000'
        - 'frontend-green:3001'
    metrics_path: '/api/metrics'
    scrape_interval: 30s
    honor_labels: true
    relabel_configs:
      - target_label: service
        replacement: 'frontend'

  # ===== DATABASE MONITORING =====
  # PostgreSQL Exporter –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres-exporter:9187']
    scrape_interval: 30s
    relabel_configs:
      - target_label: service
        replacement: 'database'
      - target_label: database_type
        replacement: 'postgresql'

  # ===== REDIS MONITORING =====
  # Redis Exporter –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–µ—à–∞
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
    scrape_interval: 30s
    relabel_configs:
      - target_label: service
        replacement: 'cache'
      - target_label: cache_type
        replacement: 'redis'

  # ===== NODE EXPORTER - SYSTEM METRICS =====
  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (CPU, Memory, Disk, Network)
  - job_name: 'node-exporter'
    static_configs:
      - targets: 
        - 'node-exporter:9100'
    scrape_interval: 15s
    relabel_configs:
      - target_label: service
        replacement: 'system'

  # ===== CADVISOR - CONTAINER METRICS =====
  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    scrape_interval: 15s
    metrics_path: /metrics
    relabel_configs:
      - target_label: service
        replacement: 'containers'

  # ===== NGINX/LOAD BALANCER MONITORING =====
  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx-exporter:9113']
    scrape_interval: 15s
    relabel_configs:
      - target_label: service
        replacement: 'load-balancer'

  # ===== SOLANA RPC MONITORING =====
  # Custom exporter –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ Solana RPC –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
  - job_name: 'solana-rpc'
    static_configs:
      - targets: ['solana-exporter:9090']
    scrape_interval: 30s
    scrape_timeout: 25s
    relabel_configs:
      - target_label: service
        replacement: 'blockchain'
      - target_label: blockchain_type
        replacement: 'solana'

  # ===== BLACKBOX EXPORTER - EXTERNAL MONITORING =====
  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–Ω–µ—à–Ω–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∏ health checks
  - job_name: 'blackbox-http'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        - https://api.mainnet-beta.solana.com      # Solana Mainnet
        - https://api.devnet.solana.com            # Solana Devnet
        - ${EXTERNAL_API_ENDPOINT:-https://api.anonymeme.io}  # Our public API
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - target_label: service
        replacement: 'external-dependencies'

  # ===== SSL CERTIFICATE MONITORING =====
  - job_name: 'blackbox-ssl'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
        - ${DOMAIN:-anonymeme.io}:443
        - api.${DOMAIN:-anonymeme.io}:443
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - target_label: service
        replacement: 'ssl-certificates'

  # ===== CUSTOM APPLICATION METRICS =====
  # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - job_name: 'anonymeme-custom-metrics'
    static_configs:
      - targets: ['metrics-collector:8080']
    scrape_interval: 30s
    metrics_path: '/custom-metrics'
    relabel_configs:
      - target_label: service
        replacement: 'application-metrics'

  # ===== TRADING VOLUME METRICS =====
  # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  - job_name: 'trading-metrics'
    static_configs:
      - targets: ['backend:8000']
    metrics_path: '/metrics/trading'
    scrape_interval: 5s  # High frequency –¥–ª—è —Ç–æ—Ä–≥–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
    scrape_timeout: 4s
    relabel_configs:
      - target_label: service
        replacement: 'trading'
      - target_label: metric_type
        replacement: 'business'

  # ===== SMART CONTRACT EVENTS =====
  # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ events –æ—Ç —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤
  - job_name: 'smart-contract-events'
    static_configs:
      - targets: ['contract-indexer:9090']
    scrape_interval: 10s
    relabel_configs:
      - target_label: service
        replacement: 'smart-contracts'
      - target_label: blockchain
        replacement: 'solana'

  # ===== SECURITY METRICS =====
  # –ú–µ—Ç—Ä–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∞—É–¥–∏—Ç–∞
  - job_name: 'security-metrics'
    static_configs:
      - targets: ['security-monitor:8080']
    scrape_interval: 60s  # –ú–µ–Ω–µ–µ —á–∞—Å—Ç—ã–π —Å–±–æ—Ä –¥–ª—è security metrics
    metrics_path: '/security/metrics'
    relabel_configs:
      - target_label: service
        replacement: 'security'

# ===== REMOTE WRITE CONFIGURATION =====
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Ç—Ä–∏–∫ –≤ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
remote_write:
  # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è AWS CloudWatch –∏–ª–∏ Grafana Cloud
  # - url: "https://prometheus-prod-10-prod-us-central-0.grafana.net/api/prom/push"
  #   basic_auth:
  #     username: "${GRAFANA_CLOUD_USER}"
  #     password: "${GRAFANA_CLOUD_API_KEY}"
  #   write_relabel_configs:
  #     - source_labels: [__name__]
  #       regex: 'anonymeme_.*'
  #       action: keep

# ===== STORAGE CONFIGURATION =====
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
storage:
  tsdb:
    # Retention period - —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ 30 –¥–Ω–µ–π
    retention.time: 30d
    # Retention size - –º–∞–∫—Å–∏–º—É–º 50GB
    retention.size: 50GB
    # Compression - –≤–∫–ª—é—á–∞–µ–º —Å–∂–∞—Ç–∏–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
    wal-compression: true